<p class="well-sm pull-right" ng-show="document.route_step && document.writable">
  <span class="btn btn-danger" ng-click="cancelWorkflow()">
    <span class="fas fa-trash"></span>
    {{ 'document.view.workflow.cancel_workflow' | translate }}
  </span>
</p>
<p class="well-sm" ng-show="document.writable">{{ 'document.view.workflow.message' | translate }}</p>

<form name="startWorkflowForm" class="form-horizontal" novalidate ng-show="!document.route_step && document.writable">
  <div class="form-group" ng-class="{ 'has-error': !startWorkflowForm.routemodel.$valid && startWorkflowForm.$dirty }">
    <label for="inputRouteModel" class="col-sm-3">
      {{ 'document.view.workflow.workflow_start_label' | translate }}
      <p ng-if="userInfo.base_functions.indexOf('ADMIN') != -1">
        <a href="#/settings/workflow">{{ 'document.view.workflow.add_more_workflow' | translate }}</a>
      </p>
    </label>
    <div class="col-sm-6">
      <select required class="form-control" id="inputRouteModel" name="routemodel" ng-model="routemodel">
        <option ng-repeat="routemodel in routemodels" value="{{ routemodel.id }}">{{ routemodel.name }}</option>
      </select>
    </div>
    <div class="col-sm-3">
      <span class="help-block" ng-show="startWorkflowForm.routemodel.$error.required && startWorkflowForm.$dirty">{{ 'validation.required' | translate }}</span>
    </div>
  </div>

  <div class="form-group">
    <div class="col-sm-offset-3 col-sm-9">
      <button type="submit" class="btn btn-primary"
              ng-disabled="!startWorkflowForm.$valid"
              ng-click="startWorkflow()">
        {{ 'document.view.workflow.start_workflow_submit' | translate }}
      </button>
    </div>
  </div>
</form>

<table class="table" ng-repeat="route in routes">
  <caption translate="document.view.workflow.full_name"
           translate-values="{ name: route.name, create_date: route.create_date }"></caption>
  <thead>
  <tr>
    <th>{{'document.view.workflow.type' | translate}}</th>
    <th>{{'document.view.workflow.name' | translate}}</th>
    <th>{{'document.view.workflow.for' | translate}}</th>
    <th>{{'document.view.workflow.validation' | translate}}</th>
    <th>{{'document.view.comments' | translate}}</th>
  </tr>
  </thead>
  <tbody>
  <tr ng-repeat="step in route.steps" ng-class="{
          'bg-success': step.transition == 'VALIDATED' || step.transition == 'APPROVED',
          'bg-danger': step.transition == 'REJECTED'
      }">
    <td>
      <span class="fas fa-exchange-alt" ng-if="step.type == 'APPROVE'"></span>
      <span class="fas fa-check-circle" ng-if="step.type == 'VALIDATE'"></span>
      {{ 'workflow_type.' + step.type | translate }}
    </td>
    <td>{{ step.name }}</td>
    <td>
      <acl data="step.target"></acl>
    </td>
    <td ng-if="!step.editingComment">
      <span ng-show="step.end_date">
          {{ 'workflow_transition.' + step.transition | translate }}
          {{ step.end_date | timeAgo: dateTimeFormat }}
          by
        <a href="#/user/{{ step.validator_username }}" class="label label-default">{{ step.validator_username }}</a>
      </span>
    </td>
    <td colspan="2" ng-if="step.editingComment">
      <div ng-show="step.comment_config.type == 'select'">
        <select class="form-control mb-10" ng-model="step.comment"
                ng-options="option.str as option.str for option in step.comment_config.options">
          <option value="">---</option>
        </select>
      </div>

      <div ng-show="step.comment_config.type == 'radio'">
        <div class="radio text-left" ng-repeat="item in step.comment_config.options">
          <label><input name="workflowCommentRadio" type="radio" ng-model="step.comment" value="{{item.str}}" ng-click="step.comment = item.str">{{item.str}}</label>
        </div>
      </div>

      <textarea ng-model="step.comment" rows="5" class="form-control mb-10" ng-show="step.comment_config.type == 'text'"
                ng-attr-placeholder="{{ 'document.view.workflow_comment' | translate }}"></textarea>
      <span class="btn btn-primary"
            ng-show="step.type == 'VALIDATE'"
            ng-click="updateWorkflowStep(step, 'VALIDATED')">
              {{ 'workflow_transition.VALIDATED' | translate }}
            </span>
      <span class="btn btn-success"
            ng-show="step.type == 'APPROVE'"
            ng-click="updateWorkflowStep(step, 'APPROVED')">
              {{ 'workflow_transition.APPROVED' | translate }}
            </span>
      <span class="btn btn-danger"
            ng-show="step.type == 'APPROVE'"
            ng-click="updateWorkflowStep(step, 'REJECTED')">
              {{ 'workflow_transition.REJECTED' | translate }}
            </span>
      <span class="btn btn-default"
            ng-click="cancelEditComment(step)">
              {{ 'cancel' | translate }}
            </span>
    </td>
    <td ng-if="canViewComment(step)">
      <span ng-if="!step.editingComment">
        {{step.comment}}
      </span>
      <button class="btn btn-link" ng-if="canEditComment(step, route)" ng-click="editComment(step)">
        {{'edit'|translate}}
      </button>
    </td>
    <td ng-if="!canViewComment(step)">
      <span class="text-muted">
        <i>{{'document.view.workflow.can_not_view_comment' | translate}}</i>
      </span>
    </td>
  </tr>
  </tbody>
</table>